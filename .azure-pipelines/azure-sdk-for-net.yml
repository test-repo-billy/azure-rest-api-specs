parameters:
  - name: SpecRepoCommit
    type: string
    default: 'HEAD'
  - name: SdkRepoCommit
    type: string
    default: 'HEAD'
  - name: ConfigType
    type: string
    values:
      - 'TypeSpec'
      - 'OpenAPI'
    default: 'TypeSpec'
    displayName: 'API specification type'
  - name: ConfigPath
    type: string
    default: 'specification/contosowidgetmanager/Contoso.Management/tspconfig.yaml'
    displayName: 'Path to API specification file (TypeSpec/OpenAPI)'
  - name: SkipPullRequestCreation
    type: boolean
    default: false

trigger:
  branches:
    include:
      - user/raych1/pipeline-sdk-auto
pr:
  branches:
    include:
      - user/raych1/pipeline-sdk-auto

jobs:
- job:
  displayName: 'SDK Generation'

  variables:
    - template: /eng/pipelines/templates/variables/image.yml
    - name: NodeVersion
      value: '22.13.x'
    - name: PythonVersion
      value: '3.13'
    - name: SpecGenSdkVersion
      value: 'latest'
    - name: SdkArtifactName
      value: SDK_Artifact

  pool:
    name: $(LINUXPOOL)
    vmImage: $(LINUXVMIMAGE)

  steps:
    - powershell: |
        $repoParts = "$(Build.Repository.Name)" -split '/'
        $specRepoOwner = $repoParts[0]
        $specRepoName = $repoParts[1]
        Write-Host "##vso[task.setvariable variable=SpecRepoOwner]$specRepoOwner"
        Write-Host "##vso[task.setvariable variable=SpecRepoName]$specRepoName"
        Write-Host "SpecRepoOwner variable set to: $specRepoOwner"
        Write-Host "SpecRepoName variable set to: $specRepoName"
        Write-Host "SdkRepoOwner from pipeline UI: $(SdkRepoOwner)"
        if ([string]::IsNullOrEmpty($(SdkRepoName)) -or [string]::IsNullOrEmpty($(SdkRepoOwner))) {
          Write-Host "##vso[task.logissue type=error]SdkRepoName and SdkRepoOwner must set in the pipeline."
          exit 1
        }
        if ([string]::IsNullOrEmpty($(IntegrationSdkRepoOwner))) {
          Write-Host "##vso[task.setvariable variable=IntegrationSdkRepoOwner]''"
          Write-Host "IntegrationSdkRepoOwner variable set to ''"
        }
        if ([string]::IsNullOrEmpty($(IntegrationSdkRepoName))) {
          Write-Host "##vso[task.setvariable variable=IntegrationSdkRepoName]''"
          Write-Host "IntegrationSdkRepoName variable set to ''"
        }
      displayName: "Initialize variables"

    - checkout: self
      path: '$(SpecRepoName)'

    - pwsh: |
        Write-Host "Build.SourcesDirectory: $(Build.SourcesDirectory)"
        Write-Host "DefaultWorkingDirectory: $(System.DefaultWorkingDirectory)"
        Write-Host "PipelineWorkspace: $(Pipeline.Workspace)"
        # Define the path to the JSON file
        $configPath = "$(Build.SourcesDirectory)/specificationRepositoryConfiguration.json"
        $jsonContent = Get-Content -Raw -Path $configPath
        $configJson = $jsonContent | ConvertFrom-Json

        # Get the 'sdkRepository' settings for the specified SDK repository
        $sdkRepositoryMappings = $configJson.sdkRepositoryMappings
        if (-not $sdkRepositoryMappings) {
          Write-Host "##vso[task.logissue type=error]No sdkRepositoryMappings found in the specificationRepositoryConfiguration.json.`
            Request help in API Spec Review Teams Channel at `
            https://aka.ms/azsdk/support/specreview-channel"
          exit 1
        }
        Write-Host "SdkRepoName from pipeline UI: $SdkRepoName"
        $mainRepository = $sdkRepositoryMappings.$SdkRepoName.mainRepository
        if (-not [string]::IsNullOrEmpty($mainRepository)) {
          # Split the value into repo owner and repo name
          $repoInfo = $mainRepository -split '/'
          $sdkRepoOwner = $repoInfo[0]
          $sdkRepoName = $repoInfo[1]
          Write-Host "##vso[task.setvariable variable=SdkRepoOwner]$sdkRepoOwner"
          Write-Host "##vso[task.setvariable variable=SdkRepoName]$sdkRepoName"
          Write-Host "SdkRepoOwner variable set to: $sdkRepoOwner"
          Write-Host "SdkRepoName variable set to: $sdkRepoName"
        } else {
          Write-Host "##vso[task.logissue type=error]mainRepository isn't set for '$SdkRepoName' in the specificationRepositoryConfiguration.json.`
            Request help in API Spec Review Teams Channel at `
            https://aka.ms/azsdk/support/specreview-channel"
          exit 1
        }

        $integrationRepository = $sdkRepositoryMappings.$sdkRepoName.integrationRepository
        if (-not [string]::IsNullOrEmpty($integrationRepository)) {
          $repoInfo = $integrationRepository -split '/'
          $integrationSdkRepoOwner = $repoInfo[0]
          $integrationSdkRepoName = $repoInfo[1]
          Write-Host "##vso[task.setvariable variable=IntegrationSdkRepoOwner]$integrationSdkRepoOwner"
          Write-Host "IntegrationSdkRepoOwner variable set to: $integrationSdkRepoOwner"
          Write-Host "##vso[task.setvariable variable=IntegrationSdkRepoName]$integrationSdkRepoName"
          Write-Host "IntegrationSdkRepoName variable set to: $integrationSdkRepoName"
        } else {
          Write-Host "Integration repository is null or empty."
        }

        # test code
        Write-Host "##vso[task.setvariable variable=BreakingChangeLabel]BreakingChange-Go-Sdk"
        Write-Host "BreakingChangeLabel variable set to: BreakingChange-Go-Sdk"
        Write-Host "##vso[task.setvariable variable=BreakingChangeLabelAction]remove"
        Write-Host "BreakingChangeLabelAction variable set to: remove"
      condition: eq(variables['Build.Reason'], 'PullRequest')
      displayName: 'Load configuration for spec-gen-sdk'

    - template: /eng/common/pipelines/templates/jobs/sdk-generation.yml
      parameters:
        SpecRepoOwner: $(SpecRepoOwner)
        SpecRepoName: $(SpecRepoName)
        SdkRepoOwner: $(SdkRepoOwner)
        SdkRepoName: $(SdkRepoName)
        IntegrationSdkRepoOwner: $(IntegrationSdkRepoOwner)
        IntegrationSdkRepoName: $(IntegrationSdkRepoName)
        SpecRepoCommit: ${{ parameters.SpecRepoCommit }}
        SdkRepoCommit: ${{ parameters.SdkRepoCommit }}
        ConfigType: ${{ parameters.ConfigType }}
        ConfigPath: ${{ parameters.ConfigPath }}
        SkipPullRequestCreation: ${{ parameters.SkipPullRequestCreation }}

    - task: PowerShell@2
      displayName: Add label to the spec PR
      condition: and(eq(variables['Build.Reason'], 'PullRequest'), ne(variables['BreakingChangeLabel'], ''), eq(variables['BreakingChangeLabelAction'], 'add'))
      inputs:
        pwsh: true
        workingDirectory: $(Build.SourcesDirectory)
        filePath: $(Build.SourcesDirectory)/eng/common/scripts/Add-IssueLabels.ps1
        arguments: >
          -RepoOwner $(SpecRepoOwner)
          -RepoName $(SpecRepoName)
          -IssueNumber "$(System.PullRequest.PullRequestNumber)"
          -Labels $(BreakingChangeLabel)
          -AuthToken "$(azuresdk-github-pat)"

    - task: PowerShell@2
      displayName: Remove label from the spec PR
      condition: and(eq(variables['Build.Reason'], 'PullRequest'), ne(variables['BreakingChangeLabel'], ''), eq(variables['BreakingChangeLabelAction'], 'remove'))
      inputs:
        pwsh: true
        workingDirectory: $(Build.SourcesDirectory)
        filePath: $(Build.SourcesDirectory)/eng/common/scripts/Remove-IssueLabel.ps1
        arguments: >
          -RepoOwner $(SpecRepoOwner)
          -RepoName $(SpecRepoName)
          -IssueNumber "$(System.PullRequest.PullRequestNumber)"
          -LabelName $(BreakingChangeLabel)
          -AuthToken "$(azuresdk-github-pat)"
